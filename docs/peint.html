<!DOCTYPE html>  <html> <head>   <title>peint.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               peint.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <pre><code>Peint.js 0.0.1
(c) 2012 Stephen Belanger, Opzi Inc.
Peint may be freely distributed under the MIT license.
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Initial Setup</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Peint depends on underscore for much
of it's array handling functionality.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Underscore is required&#39;</span><span class="p">)</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Build the global object</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nb">window</span><span class="p">.</span><span class="nx">Peint</span> <span class="o">=</span> <span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Peint uses CommonJS to manage it's components,
making it easily extendable; and making inheritance
much easier to manage.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Peint</span><span class="p">.</span><span class="nx">modules</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="kd">function</span> <span class="nx">build</span> <span class="p">(</span><span class="nx">module</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">fn</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">fn</span>
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">delete</span> <span class="nx">module</span><span class="p">.</span><span class="nx">fn</span>
    <span class="nx">fn</span><span class="p">(</span><span class="nx">Peint</span><span class="p">.</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span> <span class="nx">module</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>To use modules, they first must be required</p>

<pre><code>var Img = Peint.require('image')
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Peint</span><span class="p">.</span><span class="nx">require</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">Peint</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">id</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;module &#39;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39; not found&#39;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">Peint</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">fn</span>
      <span class="o">?</span> <span class="nx">build</span><span class="p">(</span><span class="nx">Peint</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">id</span><span class="p">])</span>
      <span class="o">:</span> <span class="nx">Peint</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">exports</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>You can also define your own Peint modules,
if you wish to extend the functionality.</p>

<pre><code>Peint.define('event-log', function (require, exports) {
  var Events = require('events')
  exports.listen = function (obj) {
    obj.on('*', function () {
      console.log(this.event())
    })
  }
})
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Peint</span><span class="p">.</span><span class="nx">define</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">Peint</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">id</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;module &#39;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39; already defined&#39;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">Peint</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">fn</span><span class="o">:</span> <span class="nx">fn</span> <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">Peint</span><span class="p">.</span><span class="nx">define</span><span class="p">.</span><span class="nx">remove</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="nx">Peint</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>You can also just load all modules into a namespaced object.
This may be removed later as modules become more branched.</p>

<pre><code>var Engine = Peint.all()
var canvas = new Engine.Canvas('#viewport')
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Peint</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">support</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;support&#39;</span><span class="p">)</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">Klass</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;klass&#39;</span><span class="p">)</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">)</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">Events</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">)</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nb">Object</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">Canvas</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">)</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">Rect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">)</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">Image</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">)</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">Animation</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;animation&#39;</span><span class="p">)</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">Group</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">Text</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">Peint</span><span class="p">.</span><span class="nx">all</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Peint</span><span class="p">.</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h2>klass</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>The Klass module provides a generic, class-based inheritance system.
It adds several conveniences, including easy superclass access.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Peint</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;klass&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">module</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">slice</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">,</span> <span class="nx">ext</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span>
  <span class="kd">function</span> <span class="nx">ctor</span> <span class="p">()</span> <span class="p">{}</span>

  <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Here's where the magic happens. We swap out the prototype of
a generic constructor, and apply it to the extended class.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">prt</span><span class="p">,</span> <span class="nx">stat</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">supr</span> <span class="o">=</span> <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>If we have a constructor to extend with, use that.
Otherwise, create an empty one to call the superclass.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">child</span> <span class="o">=</span> <span class="p">(</span><span class="nx">prt</span> <span class="o">&amp;&amp;</span> <span class="nx">prt</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;constructor&#39;</span><span class="p">))</span>
      <span class="o">?</span> <span class="nx">prt</span><span class="p">.</span><span class="nx">constructor</span>
      <span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">supr</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Now, we must inherit any static methods. Then we swap
and apply the superclass prototype to the extended class.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">ext</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">supr</span><span class="p">)</span>
    <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">supr</span><span class="p">.</span><span class="nx">prototype</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ctor</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>If we have any prototype methods or static methods,
now is the time to mix those in.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">prt</span> <span class="o">&amp;&amp;</span> <span class="nx">ext</span><span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">prt</span><span class="p">)</span>
    <span class="nx">stat</span> <span class="o">&amp;&amp;</span> <span class="nx">ext</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">stat</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Now ensure the constructor property is correct and
provide our supr convenience wrapper.</p>

<p>Functions attached to the superclass prototype can be
executed in one of two ways.</p>

<pre><code>Base.supr(this, 'constructor', 'args')
Base.supr.constructor.call(this, 'args')
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">child</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">child</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">supr</span> <span class="o">=</span> <span class="nx">ext</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">child</span><span class="p">.</span><span class="nx">supr</span><span class="p">[</span><span class="nx">fn</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="p">},</span> <span class="nx">supr</span><span class="p">.</span><span class="nx">prototype</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Lastly, the callee is attached to the child class to
allow for continued extendability.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">child</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">callee</span>
    <span class="k">return</span> <span class="nx">child</span>
  <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h2>support</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>The support module provides basic feature detection, shims and polyfills.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Peint</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;support&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">exports</span><span class="p">.</span><span class="nx">canvas</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">!!</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">getContext</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">))</span>
  <span class="p">})(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Unfortunately, requestAnimationFrame is not widely
supported yet. We need to provide a shim to
ensure an equivalent is always available.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimFrame</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span>  <span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span>
      <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">webkitRequestAnimationFrame</span>
      <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">mozRequestAnimationFrame</span>
      <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">oRequestAnimationFrame</span>
      <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">msRequestAnimationFrame</span>
      <span class="o">||</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
      <span class="p">}</span>
  <span class="p">})()</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Just as with requestAnimationFrame, cancelAnimationFrame
is also not widely supported. Another shim is needed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nb">window</span><span class="p">.</span><span class="nx">cancelRequestAnimFrame</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">cancelAnimationFrame</span>
      <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">webkitCancelRequestAnimationFrame</span>
      <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">mozCancelRequestAnimationFrame</span>
      <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">oCancelRequestAnimationFrame</span>
      <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">msCancelRequestAnimationFrame</span>
      <span class="o">||</span> <span class="nx">clearTimeout</span>
  <span class="p">})()</span>
<span class="p">})</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <h2>events</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>The events module provides a lightweight, regex-supported event system.
All major components extend from this module to provide easy propagation
of events like clicks or touches, mouse over or out and internal events
such as change and render events.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Peint</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">module</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>First off, we should build an event list unique to this object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Klass</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">events</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Using <code>on</code> we can add events to the event list.
These can be matched in several different ways;</p>

<pre><code>plain text    mouse:over
wildcard      mouse:*
regex         /mouse:\S*/
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">on</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
        <span class="nx">id</span><span class="o">:</span> <span class="nx">util</span><span class="p">.</span><span class="nx">wildcardify</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
        <span class="p">,</span> <span class="nx">fn</span><span class="o">:</span> <span class="nx">fn</span>
      <span class="p">})</span>
      <span class="k">return</span> <span class="k">this</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Using <code>emit</code> we can emit an event to all matching
listeners. All arguments after the first are passed
through to the executed listener.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">emit</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">,</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Using <code>this.event</code> you can get information about
the running event that called the listener.
This is particularly useful in situations where
a listener receives similarly handled events,
but needs to distinguish between them.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">self</span><span class="p">.</span><span class="nx">event</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">{</span>
              <span class="nx">trigger</span><span class="o">:</span> <span class="nx">i</span>
              <span class="p">,</span> <span class="nx">match</span><span class="o">:</span> <span class="nx">e</span>
              <span class="p">,</span> <span class="nx">arguments</span><span class="o">:</span> <span class="nx">args</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="nx">e</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
        <span class="p">})</span>
      <span class="k">return</span> <span class="k">this</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h2>object</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>This module provides basic display object functionality.
All display objects extend from this class at some level.
Even the canvas is handled as a display object; the viewport.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Peint</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">module</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">Events</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>All display objects provide event interfaces,
which are inherited here.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">Obj</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Events</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">opt</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Obj</span><span class="p">.</span><span class="nx">supr</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;constructor&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>All objects are assigned some sane defaults
which can be adjusted to manage placement.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">left</span><span class="o">:</span> <span class="mi">0</span>
        <span class="p">,</span> <span class="nx">top</span><span class="o">:</span> <span class="mi">0</span>
        <span class="p">,</span> <span class="nx">width</span><span class="o">:</span> <span class="mi">0</span>
        <span class="p">,</span> <span class="nx">height</span><span class="o">:</span> <span class="mi">0</span>
        <span class="p">,</span> <span class="nx">sliceX</span><span class="o">:</span> <span class="mi">0</span>
        <span class="p">,</span> <span class="nx">sliceY</span><span class="o">:</span> <span class="mi">0</span>
        <span class="p">,</span> <span class="nx">sliceWidth</span><span class="o">:</span> <span class="mi">0</span>
        <span class="p">,</span> <span class="nx">sliceHeight</span><span class="o">:</span> <span class="mi">0</span>
        <span class="p">,</span> <span class="nx">xorigin</span><span class="o">:</span> <span class="s1">&#39;left&#39;</span>
        <span class="p">,</span> <span class="nx">yorigin</span><span class="o">:</span> <span class="s1">&#39;top&#39;</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">opt</span> <span class="o">||</span> <span class="p">{},</span> <span class="p">{</span> <span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Using <code>clone</code> you can created an identical clone of an object.
You can also pass in a hash of extra properties to apply to
the newly created clone during construction.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">clone</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">desc</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">obj</span> <span class="o">||</span> <span class="p">{})</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Obj</span><span class="p">.</span><span class="nx">supr</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;constructor&#39;</span><span class="p">,</span> <span class="nx">desc</span><span class="p">)</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>This is a simplified wrapper around <code>util.animate</code> for
animating positioning properties of the current object.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">animate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">prop</span><span class="p">,</span> <span class="nx">opt</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span>
      <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{}</span>
          <span class="nx">data</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">},</span> <span class="nx">opt</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">util</span><span class="p">.</span><span class="nx">animate</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>You should always use <code>set</code> when changing properties
of display objects that will require re-rendering.
This function handle applying those properties to the
<code>this.attrs</code> hash and emitting the change event.</p>

<p>The change event can be silenced by providing
{ silent: true } as the second argument.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">)</span>
      <span class="p">;(</span><span class="nx">opts</span> <span class="o">&amp;&amp;</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">silent</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">)</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Get is a convenient function to get individual named
properties or the entire <code>this.attrs</code> hash.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">attr</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">attr</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>You can use <code>isIntersecting</code> to detect collisions with
this object. It is used internally to propagate mouse events.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">isIntersecting</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span>
        <span class="p">,</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">,</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">,</span> <span class="nx">w</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="mi">0</span>
        <span class="p">,</span> <span class="nx">h</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">||</span> <span class="mi">0</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">left</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">w</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">width</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">top</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">h</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">top</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">height</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">true</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>These four functions are helpers to move display objects
up and down through the display stack. This works with
both sorting in the base canvas, and within groups.
A change event will be emitted to inform the parent
that it needs to be re-rendered.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">toTop</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_activeCanvas</span><span class="p">.</span><span class="nx">_children</span><span class="p">.</span><span class="nx">top</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">,</span> <span class="nx">toBottom</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_activeCanvas</span><span class="p">.</span><span class="nx">_children</span><span class="p">.</span><span class="nx">bottom</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">,</span> <span class="nx">up</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_activeCanvas</span><span class="p">.</span><span class="nx">_children</span><span class="p">.</span><span class="nx">up</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">,</span> <span class="nx">down</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_activeCanvas</span><span class="p">.</span><span class="nx">_children</span><span class="p">.</span><span class="nx">down</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">)</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p><em>Experimental</em>
This is used to support aligning draw x and y origins
to opposite sides of the object, or to the middle point.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">getRealPos</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">x</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">left</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">left</span>
          <span class="p">,</span> <span class="nx">center</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">left</span> <span class="o">-</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
          <span class="p">,</span> <span class="nx">right</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">left</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">width</span>
        <span class="p">}</span>
        <span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">top</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">top</span>
          <span class="p">,</span> <span class="nx">middle</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
          <span class="p">,</span> <span class="nx">bottom</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">height</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="p">[</span>
        <span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">xorigin</span><span class="p">]</span>
        <span class="p">,</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">yorigin</span><span class="p">]</span>
      <span class="p">]</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Each object goes through three stages of rendering;</p>

<pre><code>Pre-render     Translate, scale and rotate context
Render         Draw object
Post-render    Restore context
</code></pre>

<p>First, we must translate the context position.
Then we have apply rotation, if we have the information.
After that, we apply scaling, if we have the information.
Lastly, we emit the render:pre event.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">_preRender</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_activeCanvas</span><span class="p">.</span><span class="nx">_ctx</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">states</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">states</span><span class="o">++</span>

      <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getRealPos</span><span class="p">()</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="nx">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">rotation</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">rotate</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">rotation</span><span class="p">)</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">states</span><span class="o">++</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">scale</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">scale</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">scale</span><span class="p">)</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">states</span><span class="o">++</span>
      <span class="p">}</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;render:pre&#39;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">this</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Not much happens here, that's left up to the extended
display objects. All this does is emit the render event.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">_render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;render&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_activeCanvas</span><span class="p">.</span><span class="nx">_ctx</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">this</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>The last step is to restore the previous context state.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">_postRender</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_activeCanvas</span><span class="p">.</span><span class="nx">_ctx</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;render:post&#39;</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">states</span><span class="o">--</span><span class="p">)</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span>
      <span class="k">return</span> <span class="k">this</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <h2>canvas</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>The <code>canvas</code> module manages the canvas dom element, and functions
as a container</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Peint</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">module</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">Obj</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">support</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;support&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Throw an error if canvas is not supported.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">support</span><span class="p">.</span><span class="nx">canvas</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Canvas not supported&#39;</span><span class="p">)</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>First, we must attempt to get a canvas element and
matching context. The provided <code>el</code> could be a selector,
a jquery object, a canvas dom element, or even empty.
We should try to intelligently predict how we should behave.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">Canvas</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Obj</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Canvas</span><span class="p">.</span><span class="nx">supr</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;constructor&#39;</span><span class="p">)</span>

      <span class="k">typeof</span> <span class="nx">el</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="nx">el</span><span class="p">))</span>
      <span class="p">;(</span><span class="nx">el</span> <span class="o">&amp;&amp;</span> <span class="nx">el</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">el</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span><span class="nx">el</span> <span class="k">instanceof</span> <span class="nx">HTMLCanvasElement</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">)</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>We also need to give the canvas a tab index,
so we can capture keyboard events.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">el</span><span class="p">.</span><span class="nx">tabIndex</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Now that we have that dealt with; we should store
the element, along with the context, and generate
our list of display objects.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">_el</span> <span class="o">=</span> <span class="nx">el</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_ctx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_el</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="nx">m</span> <span class="o">||</span> <span class="s1">&#39;2d&#39;</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_children</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Stack</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_lastFrame</span> <span class="o">=</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Lastly, we should initialize the base event
propagation system. We need to check if the instance
is a <code>Canvas</code> because <code>Group</code> inherits from it, and
we don't want to double up our event propagation.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Canvas</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_initEvents</span><span class="p">()</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_initKeys</span><span class="p">()</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Let's also start listening for change events and toggle
the <code>this.changed</code> state to indicate a re-render is needed.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;changed&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">changed</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="p">})</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Here we handle the setup of mouse events.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">_initEvents</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>This helper function creates named type listeners.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">function</span> <span class="nx">ev</span> <span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>When we receive a mouse event, we first should transform
the raw event to scope to the position of the canvas.
To do that, we create a transformed tap list.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">taps</span> <span class="o">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">MouseEvent</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">left</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_el</span><span class="p">.</span><span class="nx">offsetLeft</span>
            <span class="p">,</span> <span class="nx">top</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_el</span><span class="p">.</span><span class="nx">offsetTop</span>
          <span class="p">})</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Next, we should emit base-level taps and interate
our display object list. For each child object,
we need to transform the tap information again to
scope to the position of that object.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;mouse:&#39;</span><span class="o">+</span><span class="nx">type</span><span class="p">,</span> <span class="nx">taps</span><span class="p">)</span>
          <span class="nx">_</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_children</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">newTaps</span> <span class="o">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">MouseEvent</span><span class="p">(</span><span class="nx">taps</span><span class="p">,</span> <span class="nx">child</span><span class="p">.</span><span class="nx">get</span><span class="p">())</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>If any of the taps intersect with a child object,
we should propagate the transformed event up to it.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">_</span><span class="p">(</span><span class="nx">taps</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">point</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">isIntersecting</span><span class="p">(</span><span class="nx">point</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">child</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;mouse:&#39;</span><span class="o">+</span><span class="nx">type</span><span class="p">,</span> <span class="nx">newTaps</span><span class="p">)</span>
              <span class="p">}</span>
            <span class="p">})</span>
          <span class="p">})</span>
          <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Now let's use that helper to attach some listeners</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">_el</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="nx">ev</span><span class="p">(</span><span class="s1">&#39;down&#39;</span><span class="p">))</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_el</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;touchstart&#39;</span><span class="p">,</span> <span class="nx">ev</span><span class="p">(</span><span class="s1">&#39;down&#39;</span><span class="p">),</span> <span class="kc">false</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_el</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="nx">ev</span><span class="p">(</span><span class="s1">&#39;up&#39;</span><span class="p">))</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_el</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;touchend&#39;</span><span class="p">,</span> <span class="nx">ev</span><span class="p">(</span><span class="s1">&#39;up&#39;</span><span class="p">),</span> <span class="kc">false</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Move events need to work a bit differently, because we
also want to emit mouse:over and mouse:out events.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">function</span> <span class="nx">move</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">taps</span> <span class="o">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">MouseEvent</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">left</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_el</span><span class="p">.</span><span class="nx">offsetLeft</span>
          <span class="p">,</span> <span class="nx">top</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_el</span><span class="p">.</span><span class="nx">offsetTop</span>
        <span class="p">})</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>As usual, emit base-level taps, interate our display
object list, and transform the tap information again
to scope to the position of the object.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;mouse:move&#39;</span><span class="p">,</span> <span class="nx">taps</span><span class="p">)</span>
        <span class="nx">_</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_children</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">newTaps</span> <span class="o">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">MouseEvent</span><span class="p">(</span><span class="nx">taps</span><span class="p">,</span> <span class="nx">child</span><span class="p">.</span><span class="nx">get</span><span class="p">())</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>This time, however; we will be using the <code>this._hovered</code>
property to toggle hover state, allowing us to detect
the over and out mouse movements and propagate them to
the child display object.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">_</span><span class="p">(</span><span class="nx">taps</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">point</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">isIntersecting</span><span class="p">(</span><span class="nx">point</span><span class="p">))</span> <span class="p">{</span>
              <span class="nx">child</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;mouse:move&#39;</span><span class="p">,</span> <span class="nx">newTaps</span><span class="p">)</span>
              <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">child</span><span class="p">.</span><span class="nx">_hovered</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">child</span><span class="p">.</span><span class="nx">_hovered</span> <span class="o">=</span> <span class="kc">true</span>
                <span class="nx">child</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;mouse:over&#39;</span><span class="p">,</span> <span class="nx">newTaps</span><span class="p">)</span>
              <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">_hovered</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">child</span><span class="p">.</span><span class="nx">_hovered</span> <span class="o">=</span> <span class="kc">false</span>
                <span class="nx">child</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;mouse:out&#39;</span><span class="p">,</span> <span class="nx">newTaps</span><span class="p">)</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">})</span>
        <span class="p">})</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Now attach the move listeners</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">_el</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="nx">move</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_el</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;touchmove&#39;</span><span class="p">,</span> <span class="nx">move</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Here we handle the setup of keyboard events.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">_initKeys</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">downKeys</span> <span class="o">=</span> <span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>All keyboard events are handled basically the same,
so we use this generic helper to receive them.
It emits a simple keys:<code>type</code> event, but it also emits
named events for individual keys, along with combo keys.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">function</span> <span class="nx">keyTrigger</span> <span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;keys:&#39;</span><span class="o">+</span><span class="nx">type</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
        <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">_</span><span class="p">([</span><span class="s1">&#39;ctrl&#39;</span><span class="p">,</span><span class="s1">&#39;alt&#39;</span><span class="p">,</span><span class="s1">&#39;shift&#39;</span><span class="p">])</span>
          <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">e</span><span class="p">[</span><span class="nx">v</span><span class="o">+</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span> <span class="p">})</span>
        <span class="nx">keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">which</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">())</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;keys:&#39;</span><span class="o">+</span><span class="nx">type</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nx">keys</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="nx">e</span><span class="p">)</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">realDoc</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">parent</span> <span class="o">||</span> <span class="nb">window</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>This just passes press events through as-is.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">realDoc</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;keypress&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">keyTrigger</span><span class="p">(</span><span class="s1">&#39;press&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
      <span class="p">})</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Normally the dom <code>keydown</code> and <code>keyup</code> events trigger continuously,
rather than activating once like you might expect. To fix this,
we must store a list of currently held keys and ignore keys
that have already been placed in the list. </p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">realDoc</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;keydown&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!~</span><span class="nx">downKeys</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">which</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">downKeys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">which</span><span class="p">)</span>
          <span class="nx">keyTrigger</span><span class="p">(</span><span class="s1">&#39;down&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">})</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>We also need to remember to remove keys from the list of held keys
on <code>keyup</code> or future <code>keydown</code> events will continue to be stopped.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">realDoc</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;keyup&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">downKeys</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">which</span><span class="p">)</span>
        <span class="o">!!~</span><span class="nx">index</span> <span class="o">&amp;&amp;</span> <span class="nx">downKeys</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nx">keyTrigger</span><span class="p">(</span><span class="s1">&#39;up&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
      <span class="p">})</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>The <code>Canvas</code> class needs to pull <code>width</code> and <code>height</code> properties from
set calls to adjust the size of the canvas dom element.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">obj</span><span class="p">.</span><span class="nx">width</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_el</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
      <span class="nx">obj</span><span class="p">.</span><span class="nx">height</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_el</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">Canvas</span><span class="p">.</span><span class="nx">supr</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>The <code>start</code> and <code>stop</code> functions provide a convenient method of handling
re-rendering, so you don't have to think about it. Just add objects to
the display object list and this'll take care of rendering when there
is rendering to be done. You can stop and start the loop anytime.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span>
      <span class="p">;(</span><span class="kd">function</span> <span class="nx">render</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">renderLoop</span> <span class="o">=</span> <span class="nx">requestAnimFrame</span><span class="p">(</span><span class="nx">render</span><span class="p">)</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">render</span><span class="p">()</span>
      <span class="p">})()</span>
    <span class="p">}</span>
    <span class="p">,</span> <span class="nx">stop</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">renderLoop</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cancelRequestAnimFrame</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">renderLoop</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>You can set the background color using this. This will simply create
a <code>Rect</code> display object instance and add it to the display object list.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">fill</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">color</span><span class="p">,</span> <span class="nx">rect</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">rect</span> <span class="o">||</span> <span class="p">{</span>
        <span class="nx">left</span><span class="o">:</span> <span class="mi">0</span>
        <span class="p">,</span> <span class="nx">top</span><span class="o">:</span> <span class="mi">0</span>
        <span class="p">,</span> <span class="nx">width</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_el</span><span class="p">.</span><span class="nx">width</span>
        <span class="p">,</span> <span class="nx">height</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_el</span><span class="p">.</span><span class="nx">height</span>
      <span class="p">},</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="nx">color</span> <span class="p">}))</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Use <code>add</code> to add display objects to the list and connect a change event
to trigger a canvas re-render anytime that object changes.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">add</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">opt</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span>
      <span class="nx">obj</span><span class="p">.</span><span class="nx">_activeCanvas</span> <span class="o">=</span> <span class="k">this</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_children</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
      <span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="nx">self</span><span class="p">.</span><span class="nx">changed</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">})</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">changed</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Here we handle the actual rendering. This only renders the canvas a single time,
so it's recommended that you use <code>start</code> to keep an active loop.</p>

<p>This will first clear the state, then it will render each display object in the
list using the three-stage render system. Finally, it will emit a render event
to signal that rendering has completed.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">changed</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">changed</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_ctx</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_el</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_el</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">_children</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_preRender</span><span class="p">().</span><span class="nx">_render</span><span class="p">().</span><span class="nx">_postRender</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;render&#39;</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>This is a convenient factory helper to create and auto-add display objects.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">factory</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">opt</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">type</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">())</span>
      <span class="kd">var</span> <span class="nx">inst</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">obj</span><span class="p">(</span><span class="nx">opt</span><span class="p">)</span>
      <span class="nx">inst</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">opt</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">inst</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">inst</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <h2>util</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>This module provides convenient utilities. For the most part
these helpers are all just used internally.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Peint</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">Klass</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;klass&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>We don't specifically depend on jQuery, but we do need some
jQuery-like functionality for selection, so find or polyfill.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">$</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">jQuery</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Zepto</span> <span class="o">||</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">f</span> <span class="o">=</span> <span class="nx">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">i</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">document</span><span class="p">[</span><span class="s1">&#39;getElement&#39;</span> <span class="o">+</span> <span class="p">({</span>
      <span class="s1">&#39;#&#39;</span><span class="o">:</span> <span class="s1">&#39;ById&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="o">:</span> <span class="s1">&#39;sByClassName&#39;</span>
    <span class="p">}[</span><span class="nx">f</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;sByTagName&#39;</span><span class="p">)]({</span>
      <span class="s1">&#39;#&#39;</span><span class="o">:</span> <span class="nx">s</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="o">:</span> <span class="nx">s</span>
    <span class="p">}[</span><span class="nx">f</span><span class="p">]</span> <span class="o">||</span> <span class="nx">i</span><span class="p">)</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>First, lets expose the more basic parts.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">exports</span><span class="p">.</span><span class="nx">Klass</span> <span class="o">=</span> <span class="nx">Klass</span>
  <span class="nx">exports</span><span class="p">.</span><span class="nx">$</span> <span class="o">=</span> <span class="nx">$</span>
  <span class="nx">exports</span><span class="p">.</span><span class="nx">_</span> <span class="o">=</span> <span class="nx">_</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">exports</span><span class="p">,</span> <span class="nx">_</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>This is a wildcard-to-regex builder. It's used in the events
module to support wildcard fragments. Supports;</p>

<pre><code>plain text    mouse:over
wildcard      mouse:*
regex         /mouse:\S*/
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">exports</span><span class="p">.</span><span class="nx">wildcardify</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">reg</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">reg</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">reg</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">reg</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\*/g</span><span class="p">,</span> <span class="s1">&#39;[a-z0-9]*&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">reg</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>This handles the display object stacks in canvas and group objects.
Really it's just a thin layer around Array for sorting.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">Stack</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nb">Array</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">Stack</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span>
  <span class="nx">exports</span><span class="p">.</span><span class="nx">Stack</span> <span class="o">=</span> <span class="nx">Stack</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>You can move the position of an item before another.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Stack</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">move</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">b</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="nx">b</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">while</span> <span class="p">((</span><span class="nx">k</span><span class="o">--</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">undefined</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="k">this</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Or you can move items up and down the stack.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Stack</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">up</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
    <span class="o">!!~</span><span class="nx">index</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">move</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">index</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">this</span>
  <span class="p">}</span>

  <span class="nx">Stack</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">down</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
    <span class="o">!!~</span><span class="nx">index</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">move</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">this</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>You can also move items straight to the top or bottom of the stack.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Stack</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!!~</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">item</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span>
  <span class="p">}</span>

  <span class="nx">Stack</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!!~</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">item</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Or even empty it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Stack</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">empty</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">this</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>This is a handy utility for animating a property of a hash.
Unlike most animation systems, this is not tried to the dom,
so it works great for animating any type of property.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">Animate</span> <span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">obj</span> <span class="o">=</span> <span class="nx">obj</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">prop</span> <span class="o">=</span> <span class="nx">prop</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">from</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span>

    <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">animDiff</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">to</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">from</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">then</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">timer</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">step</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">)</span>
    <span class="p">},</span> <span class="mi">4</span><span class="p">)</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>We this we can set the value of the animated property. This is
used internally to ensure perfectly completed animation, rather
than potentially hitting a fractional remainder and failing.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Animate</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">set</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Here we make an animation step. This function is called at high
frequency to ensure smooth interpolation, and will calculate the
time difference between steps compared to the total duration to
smoothly adjust the value toward the final point.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">Animate</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">step</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">diff</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">now</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">then</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">diff</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">time</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">to</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">obj</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">to</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">callback</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
      <span class="nx">clearInterval</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">timer</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">animDiff</span> <span class="o">*</span> <span class="p">(</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">diff</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="p">))</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>This helper is provided as both a class and an instance factory.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">exports</span><span class="p">.</span><span class="nx">Animate</span> <span class="o">=</span> <span class="nx">Animate</span>
  <span class="nx">exports</span><span class="p">.</span><span class="nx">animate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Animate</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>These helpers are used to translate mouse and touch events
to useable touch points and lists.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">exports</span><span class="p">.</span><span class="nx">TouchPoint</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">?</span> <span class="nx">e</span> <span class="o">:</span> <span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">TouchList</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">?</span> <span class="nx">e</span> <span class="o">:</span> <span class="p">[</span><span class="nx">e</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">touches</span> <span class="o">||</span> <span class="p">[])</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>This creates transformed touch events using a supplied context.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">exports</span><span class="p">.</span><span class="nx">MouseEvent</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">_</span><span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">TouchList</span><span class="p">(</span><span class="nx">e</span><span class="p">)).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">TouchPoint</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">[</span> <span class="nx">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nx">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">top</span> <span class="p">]</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <h2>text</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>This module handles rendering of text. In most situations, it's
better to place text using dom elements, but you can use this if
you need more flexibility for things like rotations or post-process.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Peint</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">module</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">Obj</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>
  <span class="kd">var</span> <span class="nx">props</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;font&#39;</span>
    <span class="p">,</span> <span class="s1">&#39;shadowColor&#39;</span>
    <span class="p">,</span> <span class="s1">&#39;shadowOffsetX&#39;</span>
    <span class="p">,</span> <span class="s1">&#39;shadowOffsetY&#39;</span>
    <span class="p">,</span> <span class="s1">&#39;shadowBlur&#39;</span>
  <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>First, we create a Text display object with some sensible defaults.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">Text</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Obj</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">opt</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Text</span><span class="p">.</span><span class="nx">supr</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;constructor&#39;</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">font</span><span class="o">:</span> <span class="s1">&#39;10px Arial&#39;</span>
        <span class="p">,</span> <span class="nx">color</span><span class="o">:</span> <span class="s1">&#39;rgb(0,0,0)&#39;</span>
      <span class="p">},</span> <span class="nx">opt</span><span class="p">))</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>When set is called, we need to do some extra manipulation to
split up shadow into it's parts. It's arranged in the same way
as the css text-shadow property to match the font attribute.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">shadow</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">shadow</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">obj</span><span class="p">.</span><span class="nx">shadowColor</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
          <span class="nx">obj</span><span class="p">.</span><span class="nx">shadowOffsetX</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
          <span class="nx">obj</span><span class="p">.</span><span class="nx">shadowOffsetY</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
          <span class="nx">obj</span><span class="p">.</span><span class="nx">shadowBlur</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">Text</span><span class="p">.</span><span class="nx">supr</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>Before rendering, we need to apply the styles to the context.
We need to map <code>color</code> and <code>yorigin</code> to <code>fillStyle</code> and <code>textBaseline</code>
respectively, but other properties match the same naming conventions.
The result text is also measured and the <code>width</code> and <code>height</code>
attributes are adjusted to match.</p>

<p>NOTE: The height adjustment only works properly with px sizes.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">_preRender</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_activeCanvas</span><span class="p">.</span><span class="nx">_ctx</span><span class="p">,</span> <span class="nx">attrs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span>

      <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">textBaseline</span> <span class="o">=</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">yorigin</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">color</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ctx</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="nx">attrs</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span>
      <span class="p">})</span>

      <span class="kd">var</span> <span class="nx">dim</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">measureText</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">text</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">dim</span><span class="p">.</span><span class="nx">width</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">font</span><span class="p">)</span>

      <span class="k">return</span> <span class="nx">Text</span><span class="p">.</span><span class="nx">supr</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;_preRender&#39;</span><span class="p">)</span>
    <span class="p">}</span>
    </pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Now we can just render the content of the <code>text</code> attribute</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">_render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_activeCanvas</span><span class="p">.</span><span class="nx">_ctx</span><span class="p">,</span> <span class="nx">attrs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">Text</span><span class="p">.</span><span class="nx">supr</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;_render&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="p">,</span> <span class="nx">_postRender</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_activeCanvas</span><span class="p">.</span><span class="nx">_ctx</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">Text</span><span class="p">.</span><span class="nx">supr</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;_postRender&#39;</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <h2>rect</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>This module handles drawing of simple rectangles. It may be replaced in the
future with a shapes class which can handle other basic shapes and lines. </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Peint</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;rect&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">module</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">Obj</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>There's nothing special to do during construction.
Just pass any options through.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">Rect</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Obj</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">opt</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Rect</span><span class="p">.</span><span class="nx">supr</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;constructor&#39;</span><span class="p">,</span> <span class="nx">opt</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="p">,</span> <span class="nx">_preRender</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_activeCanvas</span><span class="p">.</span><span class="nx">_ctx</span>
        <span class="p">,</span> <span class="nx">attrs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span>

      <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">color</span> <span class="o">||</span> <span class="s1">&#39;#000000&#39;</span>
      <span class="k">return</span> <span class="nx">Rect</span><span class="p">.</span><span class="nx">supr</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;_preRender&#39;</span><span class="p">)</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>For the render step, we just need to set the fill color
and draw the rectangle to the specified dimensions.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">_render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_activeCanvas</span><span class="p">.</span><span class="nx">_ctx</span>
        <span class="p">,</span> <span class="nx">el</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_activeCanvas</span><span class="p">.</span><span class="nx">_el</span>
        <span class="p">,</span> <span class="nx">attrs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">el</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span>
        <span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span> <span class="nx">el</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
      <span class="p">)</span>
      <span class="k">return</span> <span class="nx">Rect</span><span class="p">.</span><span class="nx">supr</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;_render&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="p">,</span> <span class="nx">_postRender</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_activeCanvas</span><span class="p">.</span><span class="nx">_ctx</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">Rect</span><span class="p">.</span><span class="nx">supr</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;_postRender&#39;</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <h2>group</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>This module provides a grouping system so you can manipulate several
display object together. Useful for things like composing characters
from limb and torso graphics or generating tile-maps.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Peint</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">module</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">Canvas</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">Img</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>Groups are actually just Canvas objects, with some tweaks to make
them share their changes upward to a higher parent canvas context.</p>

<p>Using a method involving a group-sized image and data uris, groups
appear to the parent context as simple being an image.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">Group</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Canvas</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">opt</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Group</span><span class="p">.</span><span class="nx">supr</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;constructor&#39;</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">opt</span> <span class="o">||</span> <span class="p">{})</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">image</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">()</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">loaded</span> <span class="o">=</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>Because groups have their own set of child display objects,
we need to bridge event propagation on to the group children.
Once again, we need to translate the tap points and calculate
intersections so we can figure out what should receive events.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">([</span><span class="s1">&#39;over&#39;</span><span class="p">,</span><span class="s1">&#39;down&#39;</span><span class="p">,</span><span class="s1">&#39;up&#39;</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;mouse:&#39;</span><span class="o">+</span><span class="nx">type</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">_</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_children</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">taps</span> <span class="o">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">MouseEvent</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">child</span><span class="p">.</span><span class="nx">attrs</span><span class="p">)</span>
            <span class="nx">_</span><span class="p">(</span><span class="nx">e</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">point</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">isIntersecting</span><span class="p">(</span><span class="nx">point</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">child</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;mouse:&#39;</span><span class="o">+</span><span class="nx">type</span><span class="p">,</span> <span class="nx">taps</span><span class="p">)</span>
              <span class="p">}</span>
            <span class="p">})</span>
          <span class="p">})</span>
        <span class="p">})</span>
      <span class="p">})</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>Whenever the state of the group changes, we need to re-render
the state texture using the data url of the canvas context.
Serializing the canvas to a data url and applying it to the
state texture is asynchronous, so we need to wait for the
onload event to trigger before emitting the change event.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">isChanged</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">changed</span>
        <span class="p">,</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">Group</span><span class="p">.</span><span class="nx">supr</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;render&#39;</span><span class="p">)</span>
        <span class="p">,</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">isChanged</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_el</span><span class="p">.</span><span class="nx">toDataURL</span><span class="p">()</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="k">return</span> <span class="nx">ret</span>
    <span class="p">}</span>
    </pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>Since we are emulating an image, we can just borrow the
renderer from the image class.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">_preRender</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">Img</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_preRender</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">,</span> <span class="nx">_render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">Img</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_render</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">,</span> <span class="nx">_postRender</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">Img</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_postRender</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <h2>image</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>This module handles loading and rendering of images. It supports
rendering full images, or rendering sliced regions--handy when
combined with the animation class.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Peint</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">module</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">Obj</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>

  <span class="kd">var</span> <span class="nx">Img</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Obj</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">opt</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">image</span>
      <span class="nx">Img</span><span class="p">.</span><span class="nx">supr</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;constructor&#39;</span><span class="p">,</span> <span class="nx">opt</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setImg</span><span class="p">(</span><span class="nx">opt</span><span class="p">.</span><span class="nx">image</span> <span class="o">||</span> <span class="nx">opt</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>This sets the image for the instance to use.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">setImg</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">img</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">loaded</span> <span class="o">=</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>The image class can be given a url or an already loaded image.
In particular, cloned images will receive an existing image.
To receive these two possible inputs, we use this helper,
which adjusts the width and height properties to match the
supplied image. Then the image:loaded and change events are
emitted to ensure it gets rendered, even if it's a clone.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">function</span> <span class="nx">done</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
          <span class="nx">image</span><span class="o">:</span> <span class="nx">img</span>
          <span class="p">,</span> <span class="nx">width</span><span class="o">:</span> <span class="nx">img</span><span class="p">.</span><span class="nx">width</span>
          <span class="p">,</span> <span class="nx">height</span><span class="o">:</span> <span class="nx">img</span><span class="p">.</span><span class="nx">height</span>
        <span class="p">},</span> <span class="p">{</span> <span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">loaded</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;image:loaded&#39;</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">)</span>
        <span class="p">},</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>If we've received a preloaded image, we should just skip to
the <code>done</code> step. Otherwise, we should try to use <code>opt.url</code> to
load the image and use the <code>done</code> helper as the onload event.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">img</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="nx">done</span><span class="p">()</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">image</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">()</span>
        <span class="nx">image</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">img</span>
        <span class="nx">image</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">done</span>
        <span class="nx">img</span> <span class="o">=</span> <span class="nx">image</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>Here we render the image to the parent context. The render should
only occur when there is a loaded image to render.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">_render</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">loaded</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">attrs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">,</span> <span class="nx">el</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_activeCanvas</span><span class="p">.</span><span class="nx">_el</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_activeCanvas</span><span class="p">.</span><span class="nx">_ctx</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">image</span>
          <span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">sliceX</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span>
          <span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">sliceY</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span>
          <span class="p">,</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">sliceWidth</span> <span class="o">||</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">width</span>
          <span class="p">,</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">sliceHeight</span> <span class="o">||</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">height</span>
          <span class="p">,</span> <span class="mi">0</span>
          <span class="p">,</span> <span class="mi">0</span>
          <span class="p">,</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">width</span>
          <span class="p">,</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">height</span>
        <span class="p">)</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">Img</span><span class="p">.</span><span class="nx">supr</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;_render&#39;</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <h2>animation</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>This module handles animated images. Most of the rendering parts are
just delegated to the Img superclass, so this does little more than
translating frame numbers to scaleX/Y/Width/Height changes.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Peint</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;animation&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">module</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">Img</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>This is a simple frame-stepping helper. It just handles incrementing
and decrementing a frame number with a loop-back point.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">Frames</span> <span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">count</span> <span class="o">=</span> <span class="nx">count</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">frame</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="p">}</span>
  <span class="nx">Frames</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">frame</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">count</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">frame</span><span class="o">++</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">frame</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="p">}</span>
  <span class="nx">Frames</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">prev</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">frame</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">frame</span><span class="o">--</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">frame</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">count</span><span class="o">-</span><span class="mi">1</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>We can't do anything until the associated images is loaded, so just
pass off to the superclass and attach an event to delay the startup.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">Anim</span> <span class="o">=</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Img</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">constructor</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">opt</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Anim</span><span class="p">.</span><span class="nx">supr</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;constructor&#39;</span><span class="p">,</span> <span class="nx">opt</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;image:loaded&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_loaded</span><span class="p">)</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>Now that the image has loaded, we can use the image properties to
calculate our frame slices and start the animation. We use <code>opts.cols</code>
and <code>opts.rows</code> to determine the column and row height, which tells
us what the final tile size should be. Animated images should be
arranged horizontally, so each row is a different animationg. Once we've
calculated rows and columns, we can attach the frame-stepper and start.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">_loaded</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span>
        <span class="p">,</span> <span class="nx">anim</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">animation</span>
        <span class="p">,</span> <span class="nx">img</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">image</span>
        <span class="p">,</span> <span class="nx">width</span> <span class="o">=</span> <span class="nx">img</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="nx">anim</span><span class="p">.</span><span class="nx">cols</span>
        <span class="p">,</span> <span class="nx">height</span> <span class="o">=</span> <span class="nx">img</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="nx">anim</span><span class="p">.</span><span class="nx">rows</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
        <span class="nx">sliceWidth</span><span class="o">:</span> <span class="nx">width</span>
        <span class="p">,</span> <span class="nx">sliceHeight</span><span class="o">:</span> <span class="nx">height</span>
        <span class="p">,</span> <span class="nx">width</span><span class="o">:</span> <span class="nx">width</span>
        <span class="p">,</span> <span class="nx">height</span><span class="o">:</span> <span class="nx">height</span>
      <span class="p">})</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">_frame</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Frames</span><span class="p">(</span><span class="nx">anim</span><span class="p">.</span><span class="nx">cols</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">play</span><span class="p">()</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>We have some basic controls to pause and play the animation.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">pause</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">animating</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="p">}</span>
    <span class="p">,</span> <span class="nx">play</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">animating</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_animate</span><span class="p">()</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p>These are for stepping through the frames of an animation. In some cases,
you might want to display a paused animation and jump to specific frames
based on external triggers.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">next</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">tileSize</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">animation</span><span class="p">.</span><span class="nx">cols</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
        <span class="nx">sliceX</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_frame</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span> <span class="o">*</span> <span class="nx">tileSize</span>
      <span class="p">})</span>
    <span class="p">}</span>
    <span class="p">,</span> <span class="nx">prev</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">tileSize</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">animation</span><span class="p">.</span><span class="nx">cols</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
        <span class="nx">sliceX</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_frame</span><span class="p">.</span><span class="nx">prev</span><span class="p">()</span> <span class="o">*</span> <span class="nx">tileSize</span>
      <span class="p">})</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>Here we have the animation loop. It uses the <code>animation.duration</code>
attribute to determine time between frame steps and will continuously
recall itself in a setTimeout for easily canceling in the pause helper.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">,</span> <span class="nx">_animate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">animating</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">_animate</span><span class="p">()</span>
        <span class="p">},</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">animation</span><span class="p">.</span><span class="nx">duration</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">});</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 