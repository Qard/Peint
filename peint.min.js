((function(){function a(a){var b=a.fn;return a.exports={},delete a.fn,b(Peint.require,a.exports,a),a.exports}if(!this._)throw new Error("Underscore is required");window.Peint={},Peint.modules={},Peint.require=function(b){if(!Peint.modules[b])throw new Error("module "+b+" not found");return Peint.modules[b].fn?a(Peint.modules[b]):Peint.modules[b].exports},Peint.define=function(a,b){if(Peint.modules[a])throw new Error("module "+a+" already defined");Peint.modules[a]={id:a,fn:b}},Peint.define.remove=function(a){delete Peint.modules[a]},Peint.define("all",function(a,b){b.support=a("support"),b.Klass=a("klass"),b.util=a("util"),b.Events=a("events"),b.Object=a("object"),b.Canvas=a("canvas"),b.Rect=a("rect"),b.Image=a("image"),b.Animation=a("animation"),b.Group=a("group"),b.Text=a("text")}),Peint.all=function(){return Peint.require("all")}})).call(this),Peint.define("klass",function(a,b,c){function f(){}var d=Array.prototype.slice,e=_.extend;c.exports=function(){},c.exports.extend=function(a,b){var c=this,g=a&&a.hasOwnProperty("constructor")?a.constructor:function(){return c.apply(this,arguments)};return e(g,c),f.prototype=c.prototype,g.prototype=new f,a&&e(g.prototype,a),b&&e(g,b),g.prototype.constructor=g,g.supr=e(function(a,b){return g.supr[b].apply(a,d.call(arguments,2))},c.prototype),g.extend=arguments.callee,g}}),Peint.define("support",function(a,b){b.canvas=function(a){return!!a.getContext&&!!a.getContext("2d")}(document.createElement("canvas")),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){return window.setTimeout(a,1e3/60)}}(),window.cancelRequestAnimFrame=function(){return window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout}()}),Peint.define("events",function(a,b,c){var d=a("util");c.exports=d.Klass.extend({constructor:function(){this.events=[]},on:function(a,b){return this.events.push({id:d.wildcardify(a),fn:b}),this},emit:function(a){var b=Array.prototype.slice.call(arguments,1),c=this;return _.chain(this.events).filter(function(b){return b.id.test(a)}).each(function(d){c.event=function(){return{trigger:a,match:d,arguments:b}},d.fn.apply(c,b)}),this}})}),Peint.define("object",function(a,b,c){var d=a("events"),e=a("util"),f=c.exports=d.extend({constructor:function(a){f.supr(this,"constructor"),this.attrs={left:0,top:0,width:0,height:0,sliceX:0,sliceY:0,sliceWidth:0,sliceHeight:0,xorigin:"left",yorigin:"top"},this.set(a||{},{silent:!0})},clone:function(a){var b=_.extend({},this.attrs,a||{});return new f.supr(this,"constructor",b)},animate:function(a,b){var c=this,d=_.extend({set:function(b){var d={};d[a]=b,c.set(d)}},b);return e.animate(this.attrs,a,d)},set:function(a,b){_.extend(this.attrs,a),b&&b.silent||this.emit("change")},get:function(a){return a?this.attrs[a]:this.attrs},isIntersecting:function(a){var b=a[0],c=a[1],d=a[2]||0,e=a[3]||0;return b>this.attrs.left&&b+d<this.attrs.left+this.attrs.width&&c>this.attrs.top&&c+e<this.attrs.top+this.attrs.height?!0:!1},toTop:function(){this._activeCanvas._children.top(this),this.emit("change")},toBottom:function(){this._activeCanvas._children.bottom(this),this.emit("change")},up:function(){this._activeCanvas._children.up(this),this.emit("change")},down:function(){this._activeCanvas._children.down(this),this.emit("change")},getRealPos:function(){var a={x:{left:this.attrs.left,center:this.attrs.left-this.attrs.width/2,right:this.attrs.left-this.attrs.width},y:{top:this.attrs.top,middle:this.attrs.top-this.attrs.height/2,bottom:this.attrs.top-this.attrs.height}};return[a.x[this.attrs.xorigin],a.y[this.attrs.yorigin]]},_preRender:function(){var a=this._activeCanvas._ctx;a.states=0,a.save(),a.states++;var b=this.getRealPos();return a.translate(b[0],b[1]),this.attrs.rotation&&(a.rotate(Math.PI/180*this.attrs.rotation),a.states++),this.attrs.scale&&(a.scale(this.attrs.scale,this.attrs.scale),a.states++),this.emit("render:pre",a),this},_render:function(){return this.emit("render",this._activeCanvas._ctx),this},_postRender:function(){var a=this._activeCanvas._ctx;this.emit("render:post",a);while(a.states--)a.restore();return this}})}),Peint.define("canvas",function(a,b,c){var d=a("object"),e=a("util"),f=a("support");if(!f.canvas)throw new Error("Canvas not supported");var g=c.exports=d.extend({constructor:function(a,b){g.supr(this,"constructor"),typeof a=="string"&&(a=e.$(a)),a&&a.length&&(a=a[0]),a instanceof HTMLCanvasElement||(a=document.createElement("canvas")),a.tabIndex="1",this._el=a,this._ctx=this._el.getContext(b||"2d"),this._children=new e.Stack,this._lastFrame=0,this instanceof g&&(this._initEvents(),this._initKeys());var c=this;this.on("changed",function(){c.changed=!0})},_initEvents:function(){function b(b,c){return function(c){var d=e.MouseEvent(c,{left:a._el.offsetLeft,top:a._el.offsetTop});a.emit("mouse:"+b,d),_(a._children).each(function(a){var c=e.MouseEvent(d,a.get());_(d).each(function(d){a.isIntersecting(d)&&a.emit("mouse:"+b,c)})}),c.preventDefault()}}function c(b){var c=e.MouseEvent(b,{left:a._el.offsetLeft,top:a._el.offsetTop});a.emit("mouse:move",c),_(a._children).each(function(a){var b=e.MouseEvent(c,a.get());_(c).each(function(c){a.isIntersecting(c)?(a.emit("mouse:move",b),a._hovered||(a._hovered=!0,a.emit("mouse:over",b))):a._hovered&&(a._hovered=!1,a.emit("mouse:out",b))})}),b.preventDefault()}var a=this;this._el.addEventListener("mousedown",b("down")),this._el.addEventListener("touchstart",b("down"),!1),this._el.addEventListener("mouseup",b("up")),this._el.addEventListener("touchend",b("up"),!1),this._el.addEventListener("mousemove",c),this._el.addEventListener("touchmove",c,!1)},_initKeys:function(){function c(b,c){a.emit("keys:"+b,c);var d=_(["ctrl","alt","shift"]).filter(function(a){return c[a+"Key"]});d.push(String.fromCharCode(c.which).toLowerCase()),a.emit("keys:"+b+":"+d.join("+"),c)}var a=this,b=[],d=window.parent||window;console.log(window),d.addEventListener("keypress",function(a){c("press",a)}),d.addEventListener("keydown",function(a){~b.indexOf(a.which)||(b.push(a.which),c("down",a))}),d.addEventListener("keyup",function(a){var d=b.indexOf(a.which);!!~d&&b.splice(d,1),c("up",a)})},set:function(a){return a.width&&(this._el.width=a.width),a.height&&(this._el.height=a.height),g.supr(this,"set",a)},start:function(){var a=this;(function b(){a.renderLoop=requestAnimFrame(b),a.render()})()},stop:function(){self.renderLoop&&cancelRequestAnimFrame(self.renderLoop)},fill:function(a,b){this.factory("rect",_.extend(b||{left:0,top:0,width:this._el.width,height:this._el.height},{color:a}))},add:function(a,b){var c=this;a._activeCanvas=this,this._children.push(a),a.on("change",function(){c.changed=!0}),this.changed=!0},render:function(){if(this.changed){this.changed=!1,this._ctx.clearRect(0,0,this._el.width,this._el.height);for(var a=0;a<this._children.length;a++)this._children[a]._preRender()._render()._postRender();this.emit("render")}},factory:function(b,c){var d=a(b.toLowerCase()),e=new d(c);return e.set(c),this.add(e),e}})}),Peint.define("util",function(a,b){function e(){Array.apply(this,arguments)}function f(a,b,c){var d=this;this.obj=a,this.prop=b,this.from=a[b],_.extend(this,c),this.animDiff=this.to-this.from,this.then=new Date,this.timer=setInterval(function(){d.step.call(d)},4)}var c=a("klass"),d=window.jQuery||window.Zepto||function(a,b,c){return b=a[0],c=a.substr(1),document["getElement"+({"#":"ById",".":"sByClassName"}[b]||"sByTagName")]({"#":c,".":c}[b]||a)};b.Klass=c,b.$=d,b._=_,_.extend(b,_),b.wildcardify=function(a){return typeof a=="string"&&(a=new RegExp("^"+a.replace(/\*/g,"[a-z0-9]*")+"$","i")),a},e.prototype=new Array,b.Stack=e,e.prototype.move=function(a,b){if(b>=this.length){var c=b-this.length;while(c-- +1)this.push(undefined)}return this.splice(b,0,this.splice(a,1)[0]),this},e.prototype.up=function(a){var b=this.indexOf(a);return!!~b&&this.move(b,b-1),this},e.prototype.down=function(a){var b=this.indexOf(a);return!!~b&&this.move(b,b+1),this},e.prototype.top=function(a){var b=this.indexOf(a);return!~b||(this.splice(this.indexOf(a),1),this.push(a)),this},e.prototype.bottom=function(a){var b=this.indexOf(a);return!~b||(this.splice(this.indexOf(a),1),this.unshift(a)),this},e.prototype.empty=function(){return this.splice(0,this.length),this},f.prototype.set=function(a){this.obj[this.prop]=a},f.prototype.step=function(){this.now=new Date,this.diff=this.now-this.then;if(this.diff>this.time){this.set(this.to),this.obj[this.prop]=this.to,this.callback&&this.callback.call(this),clearInterval(this.timer);return}this.set(this.animDiff*(Math.floor(this.diff/this.time*100)/100)+this.from)},b.Animate=f,b.animate=function(a,b,c){return new f(a,b,c)},b.TouchPoint=function(a){return _.isArray(a)?a:[a.pageX,a.pageY]},b.TouchList=function(a){return _.isArray(a)?a:[a].concat(a.touches||[])},b.MouseEvent=function(a,c){return _(b.TouchList(a)).map(function(a){return a=b.TouchPoint(a),[a[0]-c.left,a[1]-c.top]})}}),Peint.define("text",function(a,b,c){var d=a("object"),e=["font","shadowColor","shadowOffsetX","shadowOffsetY","shadowBlur"],f=c.exports=d.extend({constructor:function(a){f.supr(this,"constructor",_.extend({font:"10px Arial",color:"rgb(0,0,0)"},a))},set:function(a,b){if(a.shadow){var c=a.shadow.split(" ");c.length===4&&(a.shadowColor=c[3],a.shadowOffsetX=parseInt(c[0]),a.shadowOffsetY=parseInt(c[1]),a.shadowBlur=parseInt(c[2]))}f.supr(this,"set",a,b)},_preRender:function(){var a=this._activeCanvas._ctx,b=this.attrs;a.save(),a.textBaseline=b.yorigin,a.fillStyle=b.color,_.each(e,function(c){a[c]=b[c]});var c=a.measureText(b.text);return this.attrs.width=c.width,this.attrs.height=parseInt(b.font),f.supr(this,"_preRender")},_render:function(){var a=this._activeCanvas._ctx,b=this.attrs;return a.fillText(b.text,0,0),f.supr(this,"_render")},_postRender:function(){var a=this._activeCanvas._ctx;return a.restore(),f.supr(this,"_postRender")}})}),Peint.define("rect",function(a,b,c){var d=a("object"),e=c.exports=d.extend({constructor:function(a){e.supr(this,"constructor",a)},_preRender:function(){var a=this._activeCanvas._ctx,b=this.attrs;return a.save(),a.fillStyle=b.color||"#000000",e.supr(this,"_preRender")},_render:function(){var a=this._activeCanvas._ctx,b=this._activeCanvas._el,c=this.attrs;return a.fillRect(0,0,Math.min(c.width,b.width),Math.min(c.height,b.height)),e.supr(this,"_render")},_postRender:function(){var a=this._activeCanvas._ctx;return a.restore(),e.supr(this,"_postRender")}})}),Peint.define("group",function(a,b,c){var d=a("canvas"),e=a("image"),f=a("util"),g=c.exports=d.extend({constructor:function(a){g.supr(this,"constructor"),this.set(a||{}),this.start(),this.attrs.image=new Image,this.loaded=!0;var b=this;_.each(["over","down","up"],function(a){b.on("mouse:"+a,function(c){_(b._children).each(function(b){var d=f.MouseEvent(c,b.attrs);_(c).each(function(c){b.isIntersecting(c)&&b.emit("mouse:"+a,d)})})})})},render:function(){var a=this.changed,b=g.supr(this,"render"),c=this;return a&&(this.attrs.image.src=this._el.toDataURL(),this.attrs.image.onload=function(){c.emit("change")}),b},_preRender:function(){return e.prototype._preRender.call(this)},_render:function(){return e.prototype._render.call(this)},_postRender:function(){return e.prototype._postRender.call(this)}})}),Peint.define("image",function(a,b,c){var d=a("object"),e=c.exports=d.extend({constructor:function(a){var b=this,c;e.supr(this,"constructor",a),this.setImg(a.image||a.url)},setImg:function(a){function c(){b.set({image:a,width:a.width,height:a.height},{silent:!0}),b.loaded=!0,setTimeout(function(){b.emit("image:loaded").emit("change")},0)}var b=this;this.loaded=!1,typeof a!="string"?c():(image=new Image,image.src=a,image.onload=c,a=image)},_render:function(){if(this.loaded){var a=this.attrs,b=this._activeCanvas._el;this._activeCanvas._ctx.drawImage(this.attrs.image,Math.max(0,a.sliceX||0),Math.max(0,a.sliceY||0),a.sliceWidth||a.width,a.sliceHeight||a.height,0,0,a.width,a.height)}return e.supr(this,"_render")}})}),Peint.define("animation",function(a,b,c){function e(a){this.count=a,this.frame=0}var d=a("image");e.prototype.next=function(){return this.frame<this.count-1?this.frame++:this.frame=0},e.prototype.prev=function(){return this.frame>0?this.frame--:this.frame=this.count-1};var f=c.exports=d.extend({constructor:function(a){f.supr(this,"constructor",a),this.on("image:loaded",this._loaded)},_loaded:function(){var a=this,b=this.attrs.animation,c=this.attrs.image,d=c.width/b.cols,f=c.height/b.rows;this.set({sliceWidth:d,sliceHeight:f,width:d,height:f}),this._frame=new e(b.cols),this.play()},pause:function(){this.animating=!1},play:function(){this.animating=!0,this._animate()},next:function(){this.set({sliceX:this._frame.next()*(this.attrs.image.width/this.attrs.animation.cols)})},prev:function(){this.set({sliceX:this._frame.prev()*(this.attrs.image.width/this.attrs.animation.cols)})},_animate:function(){if(this.animating){var a=this;setTimeout(function(){a.next(),a._animate()},this.attrs.animation.duration)}}})})